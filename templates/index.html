<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>録音コントローラー | Raspberry Pi</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --color-canvas-default: #F6F8FA;
            --color-canvas-inset: #F6F8FA;
            --color-header-bg: #24292F;
            --color-header-text: #ffffff;
            --color-text-primary: #1F2328;
            --color-text-secondary: #656D76;
            --color-border-default: #D0D7DE;
            --color-border-muted: #D8DEE4;
            --color-neutral-muted: rgba(175, 184, 193, 0.2);
            --color-accent-fg: #0969DA;
            --color-accent-emphasis: #0969DA;
            --color-success-fg: #1A7F37;
            --color-danger-fg: #CF222E;
            --color-btn-bg: #F6F8FA;
            --color-btn-hover-bg: #F3F4F6;
            --color-btn-primary-bg: #2DA44E;
            --color-btn-primary-hover-bg: #2C974B;
            --color-btn-primary-text: #ffffff;
            --color-btn-danger-hover-bg: #CF222E;
            --color-btn-danger-hover-text: #ffffff;
            --color-btn-danger-hover-border: #CF222E;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }

        body {
            margin: 0;
            background-color: var(--color-canvas-default);
            font-family: var(--font-family-sans-serif);
            color: var(--color-text-primary);
            font-size: 14px;
            line-height: 1.5;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .gh-header {
            background-color: var(--color-header-bg);
            color: var(--color-header-text);
            padding: 12px 24px;
            padding-left: max(24px, env(safe-area-inset-left));
            padding-right: max(24px, env(safe-area-inset-right));
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 600;
        }

        .gh-header-icon {
            fill: currentColor;
        }

        .recording-control-bar {
            background-color: #ffffff;
            border-bottom: 1px solid var(--color-border-default);
            padding: 16px 24px;
            padding-left: max(24px, env(safe-area-inset-left));
            padding-right: max(24px, env(safe-area-inset-right));
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .recording-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex: 1;
        }

        .device-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: var(--color-canvas-inset);
            border-radius: 6px;
            font-size: 13px;
            min-width: 0;
            flex: 1;
        }

        .device-display .device-name {
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bluetooth-icon {
            fill: var(--color-accent-fg);
            flex-shrink: 0;
        }

        /* 音声レベルメーター */
        .audio-meter {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background-color: var(--color-canvas-inset);
            border-radius: 6px;
            min-width: 200px;
        }

        .meter-container {
            flex: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4CAF50, #8BC34A, #FFEB3B, #FF9800, #F44336);
            transition: width 0.05s ease-out;
            will-change: width;
        }

        .meter-peak {
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background-color: #ff0000;
            transition: right 0.3s ease-out;
            opacity: 0;
        }

        .meter-peak.active {
            opacity: 1;
        }

        .meter-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            min-width: 60px;
            text-align: right;
        }

        /* WebSocket接続状態 */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background-color: var(--color-canvas-inset);
            border-radius: 6px;
            font-size: 12px;
            color: var(--color-text-primary);  /* 文字色を黒系に */
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
            animation: none;
        }

        .connection-status.connected .connection-dot {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected .connection-dot {
            background-color: #F44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 大きな録音ボタン */
        .btn-record {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            padding: 8px 20px;
            border: 1px solid rgba(27, 31, 36, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.3, 0, 0.5, 1);
            min-height: 44px;
        }

        .btn-record.start {
            background-color: var(--color-btn-primary-bg);
            color: var(--color-btn-primary-text);
        }

        .btn-record.start:hover:not(:disabled) {
            background-color: var(--color-btn-primary-hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-record.stop {
            background-color: #fff;
            color: var(--color-danger-fg);
            border-color: var(--color-danger-fg);
        }

        .btn-record.stop:hover:not(:disabled) {
            background-color: var(--color-btn-danger-hover-bg);
            color: var(--color-btn-danger-hover-text);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-record:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-record:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0;
        }

        .repo-header {
            padding: 16px 24px;
            padding-left: max(24px, env(safe-area-inset-left));
            padding-right: max(24px, env(safe-area-inset-right));
        }

        .repo-name {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-accent-fg);
        }

        .repo-name a {
            color: inherit;
            text-decoration: none;
        }

        .repo-name strong {
            font-weight: 600;
        }

        .access-info {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: #E1F5FE;
            border-radius: 6px;
            font-size: 13px;
            color: #0277BD;
        }

        .access-info code {
            font-family: monospace;
            background-color: rgba(255,255,255,0.5);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 0 16px 24px;
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }
        
        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 1.5fr 1fr;
                gap: 24px;
                padding: 0 24px 24px;
                padding-left: max(24px, env(safe-area-inset-left));
                padding-right: max(24px, env(safe-area-inset-right));
            }
            
            .recording-control-bar {
                flex-wrap: nowrap;
            }
        }
        
        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .Box {
            background-color: #ffffff;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .Box-header {
            padding: 12px 16px;
            background-color: var(--color-canvas-inset);
            border-bottom: 1px solid var(--color-border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .Box-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .Box-body {
            padding: 16px;
        }

        .Box-row {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border-muted);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.1s ease;
            min-height: 44px;
        }
        .Box-row:last-child {
            border-bottom: none;
        }
        .Box-row:hover {
            background-color: var(--color-canvas-default);
        }
        .Box-row.selected {
            background-color: #DDF4FF;
            border-left: 3px solid var(--color-accent-emphasis);
            padding-left: 13px;
        }
        
        .Box-row-icon {
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }

        .Box-row-content {
            flex: 1;
            min-width: 0;
        }
        
        .Box-row-content a {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .Box-row-content .text-bold {
            font-weight: 600;
        }
        
        .Box-row-content .text-muted {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .Box-row-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        @media (max-width: 640px) {
            .Box-row {
                padding: 12px;
                gap: 8px;
            }
            
            .Box-row-content {
                flex: 1;
                min-width: 0;
            }
            
            .Box-row-actions {
                display: flex;
                gap: 4px;
                flex-shrink: 0;
            }
            
            .Box-row-actions .btn {
                padding: 6px 10px;
            }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 9999px;
            border: 1px solid transparent;
        }
        
        .status-badge.connected {
            color: var(--color-success-fg);
            border-color: rgba(46, 160, 67, 0.4);
            background-color: #dafbe1;
        }

        .status-badge.paired {
            color: var(--color-text-secondary);
            border-color: var(--color-border-muted);
            background-color: #F6F8FA;
        }
        
        .status-badge.pending,
        .status-badge.stopping {
            color: #8250DF;
            border-color: rgba(130, 80, 223, 0.4);
            background-color: #EDE9FF;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            padding: 5px 16px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-btn-bg);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.3, 0, 0.5, 1);
        }
        .btn:hover:not(:disabled) {
            background-color: var(--color-btn-hover-bg);
            transform: translateY(-1px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-sm {
            padding: 3px 12px;
            font-size: 12px;
        }
        
        .btn-sm .octicon {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background-color: var(--color-btn-primary-bg);
            color: var(--color-btn-primary-text);
            border-color: rgba(27, 31, 36, 0.15);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-btn-primary-hover-bg);
        }
        
        .btn-danger {
            color: var(--color-danger-fg);
        }

        .btn-danger:hover:not(:disabled) {
            color: var(--color-btn-danger-hover-text);
            background-color: var(--color-btn-danger-hover-bg);
            border-color: var(--color-btn-danger-hover-border);
        }
        
        .btn-text {
            display: inline;
        }
        
        @media (max-width: 480px) {
            .btn-text {
                display: none;
            }
            
            .btn-sm {
                padding: 6px 8px;
            }
        }

        .empty-state {
            padding: 32px;
            text-align: center;
            color: var(--color-text-secondary);
        }
        
        .Box-footer {
            padding: 8px 16px; 
            border-top: 1px solid var(--color-border-default);
            background-color: var(--color-canvas-inset);
        }
        
        .sidebar .Box {
            max-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }
        
        #device-list {
            overflow-y: auto;
            flex: 1;
            min-height: 200px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border-default);
            border-top-color: var(--color-accent-emphasis);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .recording-timer {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: #FFFBDD;
            border: 1px solid #EAC54F;
            border-radius: 6px;
            font-weight: 600;
            color: #BF8700;
        }

        .recording-timer.active {
            display: flex;
        }

        .recording-timer .timer-text {
            font-family: monospace;
            font-size: 18px;
        }

        .recording-timer svg {
            animation: pulse 1s infinite;
        }

        .user-message {
            padding: 8px;
            border-radius: 6px;
            display: none;
            animation: slideIn 0.3s ease-out;
            position: fixed;
            top: 60px;  /* ヘッダーの下に表示 */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }

        @media (max-width: 767px) {
            .recording-control-bar {
                padding: 12px 16px;
                gap: 12px;
            }

            .device-display {
                flex: 1 1 100%;
                order: 3;
            }

            .recording-controls {
                flex: 1 1 100%;
                justify-content: space-between;
                order: 1;
            }

            .audio-meter {
                order: 2;
                min-width: 150px;
            }

            .main-grid {
                padding: 0 16px 16px;
            }

            .repo-header {
                padding: 16px;
            }
            
            .sidebar .Box {
                max-height: calc(100vh - 200px);
                display: flex;
                flex-direction: column;
            }
            
            #device-list {
                overflow-y: auto;
                flex: 1;
                min-height: 200px;
            }
            
            .Box-footer {
                position: sticky;
                bottom: 0;
                background-color: #ffffff;
                box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>

    <header class="gh-header">
        <svg height="24" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="24" class="gh-header-icon">
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM3.5 8a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Z"></path>
        </svg>
        <span>ZeroPi-TeamsRecorder</span>
        <div class="connection-status" id="connection-status">
            <span class="connection-dot"></span>
            <span id="connection-text">接続中...</span>
        </div>
    </header>

    <!-- 録音コントロールバー -->
    <div class="recording-control-bar">
        <div class="recording-controls">
            <button id="start-button" class="btn-record start" onclick="startRecording()" disabled>
                <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.379 5.227A.75.75 0 0 1 7.5 5.75v4.5a.75.75 0 0 1-1.121.623l-3.5-2.25a.75.75 0 0 1 0-1.246l3.5-2.25z"></path></svg>
                録音開始
            </button>
            <button id="stop-button" class="btn-record stop" onclick="stopRecording()" disabled style="display: none;">
                <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.25 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm3.5 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0z"></path></svg>
                録音停止
            </button>

            <!-- 録音中タイマー -->
            <div class="recording-timer" id="recording-timer">
                <svg width="16" height="16" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="6" fill="currentColor" opacity="0.3"/>
                    <circle cx="8" cy="8" r="3" fill="currentColor"/>
                </svg>
                <span class="timer-text" id="timer">00:00:00</span>
            </div>
        </div>

        <!-- 音声レベルメーター -->
        <div class="audio-meter" id="audio-meter">
            <div class="meter-container">
                <div class="meter-bar" id="meter-bar"></div>
                <div class="meter-peak" id="meter-peak"></div>
            </div>
            <div class="meter-label" id="meter-label">-60 dB</div>
        </div>

        <!-- デバイス表示 -->
        <div class="device-display">
            <svg class="bluetooth-icon" width="16" height="16" viewBox="0 0 16 16">
                <path d="M3.75 0a.75.75 0 0 0-1.5 0v4.333L.97 3.05a.75.75 0 0 0-1.06 1.06L2.5 6.75v2.5L-.11 11.89a.75.75 0 1 0 1.06 1.06l1.28-1.28V16a.75.75 0 0 0 1.5 0v-4.333l1.28 1.28a.75.75 0 0 0 1.06-1.06L3.75 9.25v-2.5l2.61-2.64a.75.75 0 0 0-1.06-1.06L3.75 4.333V0Zm1.5 6L7.86 3.39a.75.75 0 0 1 1.06 1.06L6.31 7.06a.75.75 0 0 1 0 1.06l2.61 2.61a.75.75 0 1 1-1.06 1.06L5.25 9.18v-3.18Zm3.69 2.61L11.55 6l-2.61-2.61a.75.75 0 0 1 1.06-1.06l3.16 3.16a.75.75 0 0 1 0 1.06l-3.16 3.16a.75.75 0 1 1-1.06-1.06Z"></path>
            </svg>
            <span class="device-name" id="device-name">デバイス未選択</span>
        </div>
    </div>

    <div class="page-content">
        <div class="repo-header">
            <div class="repo-name">
                <svg class="gh-header-icon" height="24" viewBox="0 0 16 16" version="1.1" width="24">
                    <path fill-rule="evenodd" d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25a.25.25 0 01.25-.25h3.5a.25.25 0 01.25.25v3.25a.25.25 0 01-.4.2l-1.45-1.087a.25.25 0 00-.3 0L5.4 15.7a.25.25 0 01-.4-.2v-3.25z"></path>
                </svg>
                <a href="#">Raspberry Pi</a> / <strong>Web Recorder</strong>
            </div>
            <div class="access-info">
                <strong>アクセス方法:</strong> 
                <code id="mdns-url">http://{{ mdns_address }}:8080</code> または 
                <code id="ip-url">http://{{ ip_address }}:8080</code>
            </div>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <div class="Box">
                    <div class="Box-header">
                        <h3 class="Box-title">録音ファイル</h3>
                    </div>
                    <div id="file-list" class="Box-body" style="padding: 0;">
                        <!-- ファイルリストがここに動的に挿入されます -->
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="Box">
                    <div class="Box-header">
                        <h3 class="Box-title">Bluetoothデバイス</h3>
                        <button class="btn" onclick="refreshDevices()" id="refresh-btn">
                            <span id="refresh-text">更新</span>
                            <div id="refresh-spinner" class="spinner" style="display: none;"></div>
                        </button>
                    </div>
                    <div id="device-list">
                        <div class="empty-state">
                            <p>デバイスを読み込み中...</p>
                        </div>
                    </div>
                    <div class="Box-footer">
                        <button class="btn" style="width: 100%;" onclick="saveSelectedDevice()" id="save-btn" disabled>
                            このデバイスを使用する
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- メッセージ表示エリア（固定位置） -->
    <div id="user-message" class="user-message"></div>
    
    <script>
        let selectedDevice = null;
        let socket = null;
        let timerInterval;
        let recordingStartTime;
        let isRecording = false;
        let audioLevelUpdateTime = 0;
        let peakLevel = 0;
        let peakDecayTimer;
        let animationFrame;

        // === WebSocket接続（改善版） ===
        function initWebSocket() {
            socket = io();
            
            // 接続オプションを追加
            socket.on('connect', () => {
                console.log('WebSocket接続成功');
                updateConnectionStatus(true);
                // 接続時に即座にステータスを要求
                socket.emit('request_status');
            });

            socket.on('disconnect', () => {
                console.log('WebSocket切断');
                updateConnectionStatus(false);
            });

            socket.on('status_update', (status) => {
                console.log('ステータス更新:', status);
                updateRecordingStatus(status);
            });

            socket.on('audio_level', (data) => {
                updateAudioLevel(data);
            });

            // 新しいイベントハンドラー（高速版）
            socket.on('recording_started', (data) => {
                showMessage(data.message, 'success');
            });

            socket.on('recording_stopped', (data) => {
                showMessage(data.message, 'success');
                setTimeout(updateFileList, 2000);
            });

            socket.on('recording_error', (data) => {
                showMessage(data.message, 'error');
                // エラー時はUIを元に戻す
                updateRecordingStatus({ recording: false, status: 'idle' });
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            
            if (connected) {
                statusEl.classList.add('connected');
                statusEl.classList.remove('disconnected');
                textEl.textContent = '接続済み';
            } else {
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
                textEl.textContent = '切断';
            }
        }

        function updateRecordingStatus(status) {
            const isPending   = status.status === 'pending';
            const isStopping  = status.status === 'stopping';
            isRecording = status.recording === 'true' || status.recording === true;
            const recordingTimer = document.getElementById('recording-timer');

            const startBtn = document.getElementById('start-button');
            const stopBtn = document.getElementById('stop-button');

            if (isPending) {
                // 録音準備中
                startBtn.disabled = true;
                startBtn.innerHTML = '<div class="spinner"></div> 準備中…';
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
            } else if (isStopping) {
                // 停止処理中
                startBtn.style.display = 'none';
                stopBtn.style.display  = 'inline-flex';
                stopBtn.disabled       = true;
                stopBtn.innerHTML = '<div class="spinner"></div> 停止中…';
            } else if (isRecording) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.25 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm3.5 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0z"></path></svg> 録音停止';
            } else {
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
                startBtn.disabled = !selectedDevice;
                startBtn.innerHTML = '<svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.379 5.227A.75.75 0 0 1 7.5 5.75v4.5a.75.75 0 0 1-1.121.623l-3.5-2.25a.75.75 0 0 1 0-1.246l3.5-2.25z"></path></svg> 録音開始';
            }

            if (isRecording) {
                recordingTimer.classList.add('active');
                if (!timerInterval && status.start_time) {
                    recordingStartTime = status.start_time * 1000;
                    timerInterval = setInterval(updateTimer, 1000);
                    updateTimer();
                }
            } else {
                recordingTimer.classList.remove('active');
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('timer').textContent = '00:00:00';
                updateAudioLevel({ level: 0, db: -60 });
            }
        }

        function updateAudioLevel(data) {
            const meterBar = document.getElementById('meter-bar');
            const meterPeak = document.getElementById('meter-peak');
            const meterLabel = document.getElementById('meter-label');
            
            if (isRecording && data.level !== undefined) {
                // requestAnimationFrameで最適化
                if (!animationFrame) {
                    animationFrame = requestAnimationFrame(() => {
                        // レベルをパーセンテージに変換（0-100%）
                        const percentage = Math.min(Math.max(data.level * 100, 0), 100);
                        meterBar.style.width = percentage + '%';
                        
                        // ピークレベル更新
                        if (data.peak !== undefined && data.peak > peakLevel) {
                            peakLevel = data.peak;
                            const peakPercentage = Math.min(peakLevel * 100, 100);
                            meterPeak.style.right = (100 - peakPercentage) + '%';
                            meterPeak.classList.add('active');
                            
                            // ピーク減衰タイマーリセット
                            clearTimeout(peakDecayTimer);
                            peakDecayTimer = setTimeout(() => {
                                peakLevel *= 0.9;
                                if (peakLevel < 0.01) {
                                    meterPeak.classList.remove('active');
                                }
                            }, 1000);
                        }
                        
                        // dB表示
                        if (data.db !== undefined) {
                            meterLabel.textContent = data.db.toFixed(1) + ' dB';
                        }
                        
                        animationFrame = null;
                    });
                }
            } else {
                meterBar.style.width = '0%';
                meterPeak.classList.remove('active');
                meterLabel.textContent = '-60 dB';
                peakLevel = 0;
            }
        }

        // === 初期化処理 ===
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            loadDevices();
            updateFileList();
        });

        // === UI更新関数 ===
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('user-message');
            messageEl.textContent = text;
            messageEl.className = `user-message message-${type}`;
            messageEl.style.display = 'block';
            // 既存のタイマーをクリア
            if (messageEl.hideTimer) {
                clearTimeout(messageEl.hideTimer);
            }
            // アニメーション付きで非表示
            messageEl.hideTimer = setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => { messageEl.style.display = 'none'; messageEl.style.animation = ''; }, 300);
            }, 3000);
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('start-button');
            const stopBtn = document.getElementById('stop-button');

            if (isRecording) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                stopBtn.disabled = false;
            } else {
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
                startBtn.disabled = !selectedDevice;
            }
        }

        function updateTimer() {
            if (!recordingStartTime) return;
            const now = Date.now();
            const elapsed = Math.floor((now - recordingStartTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // === データ取得・操作関数（WebSocket版） ===
        async function loadDevices() {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = '';

            try {
                const response = await fetch('/get_devices');
                const data = await response.json();
                
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        const row = document.createElement('div');
                        row.className = 'Box-row';
                        row.onclick = () => selectDevice(row, device);

                        let statusBadge = '';
                        if (device.connected) {
                            statusBadge = `<span class="status-badge connected"><span class="status-dot"></span>接続済み</span>`;
                        } else if (device.paired) {
                            statusBadge = `<span class="status-badge paired">ペアリング済み</span>`;
                        }

                        row.innerHTML = `
                            <div class="Box-row-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                                    <path d="M8.543 3.207v4.008l2.75-2.536a.75.75 0 0 1 1.075.064.75.75 0 0 1-.071 1.05l-2.75 2.535 2.75 2.535a.75.75 0 0 1-1.004 1.115l-2.75-2.536v4.008a.75.75 0 0 1-1.286.53L3.736 10.77a.75.75 0 0 1 0-1.042l1.77-1.77-1.77-1.77a.75.75 0 0 1 0-1.042l3.52-3.209a.75.75 0 0 1 1.287.53Zm-5.261 4.75 1.771 1.771 1.771-1.771-1.77-1.771-1.772 1.77Z"/>
                                </svg>
                            </div>
                            <div class="Box-row-content">
                                <span class="text-bold">${device.name}</span>
                                <div class="text-muted">${device.mac}</div>
                            </div>
                            ${statusBadge}
                        `;
                        deviceList.appendChild(row);
                    });

                    if (data.current_device) {
                        data.devices.forEach((device, index) => {
                            if (device.mac === data.current_device.mac) {
                                deviceList.children[index].classList.add('selected');
                                selectedDevice = device;
                                document.getElementById('device-name').textContent = device.name;
                            }
                        });
                    }
                } else {
                    deviceList.innerHTML = '<div class="Box-row">利用可能なデバイスが見つかりません。</div>';
                }
                updateButtonStates();
            } catch (error) {
                console.error('デバイス一覧の取得に失敗:', error);
                deviceList.innerHTML = '<div class="Box-row text-danger">デバイス一覧の取得に失敗しました。</div>';
            }
        }

        async function selectDevice(element, device) {
            document.querySelectorAll('#device-list .Box-row').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedDevice = device;
            document.getElementById('device-name').textContent = device.name;
            showMessage(`デバイス「${device.name}」を選択しました。`);

            try {
                const response = await fetch('/save_device', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(device)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    await checkConnection(device);
                } else {
                    showMessage(result.message, 'error');
                    selectedDevice = null;
                    element.classList.remove('selected');
                    document.getElementById('device-name').textContent = 'デバイス未選択';
                }
            } catch (error) {
                showMessage('デバイスの保存に失敗しました。', 'error');
                console.error('Error saving device:', error);
            }
            updateButtonStates();
        }

        async function checkConnection(device) {
            try {
                const response = await fetch('/check_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(device)
                });
                const data = await response.json();
                if (data.connected) {
                    showMessage(`デバイス ${device.name} に接続済みです。`, 'success');
                } else {
                    showMessage(`デバイス ${device.name} への接続を試みています...`, 'info');
                }
                loadDevices();
            } catch (error) {
                console.error('接続確認エラー:', error);
            }
        }

        // === 録音操作（WebSocket版） ===
        function startRecording() {
            if (!selectedDevice) {
                showMessage('録音を開始する前にデバイスを選択してください。', 'error');
                return;
            }
            
            // 即座にUIを更新
            updateRecordingStatus({ recording: false, status: 'pending' });
            
            // WebSocketで録音開始
            socket.emit('start_recording', { 
                device: selectedDevice,
                duration: 120
            });
        }

        function stopRecording() {
            // 即座にUIを更新
            updateRecordingStatus({ recording: true, status: 'stopping' });
            
            // WebSocketで録音停止
            socket.emit('stop_recording');
        }

        async function updateFileList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<div class="Box-row"><div class="spinner"></div>&nbsp;読み込み中...</div>';

            try {
                const response = await fetch('/get_files');
                const data = await response.json();

                if (data && Array.isArray(data.files) && data.files.length > 0) {
                    fileList.innerHTML = data.files.map(file => `
                        <div class="Box-row">
                            <div class="Box-row-icon">
                                <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" fill="currentColor">
                                    <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586a.75.75 0 0 1 .53.22l2.914 2.914a.75.75 0 0 1 .22.53V14.25c0 .966-.784 1.75-1.75 1.75H3.75A1.75 1.75 0 0 1 2 14.25V1.75Z"></path>
                                </svg>
                            </div>
                            <div class="Box-row-content">
                                <span class="text-bold">${file}</span>
                            </div>
                            <div class="Box-row-actions">
                                <button class="btn btn-sm" onclick="downloadFile('${file}')">
                                    <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path><path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"></path></svg>
                                    <span class="btn-text">Download</span>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file}')">
                                    <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"></path></svg>
                                    <span class="btn-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    fileList.innerHTML = '<div class="empty-state"><p>録音ファイルはありません。</p></div>';
                }
            } catch (error) {
                console.error('ファイルリストの取得に失敗:', error);
                fileList.innerHTML = '<div class="empty-state"><p style="color: var(--color-danger-fg);">ファイルリストの取得に失敗しました。</p></div>';
            }
        }

        function downloadFile(filename) {
            window.location.href = `/download/${filename}`;
        }

        async function deleteFile(filename) {
            if (!confirm(`本当にファイル「${filename}」を削除しますか？`)) {
                return;
            }
            try {
                const response = await fetch(`/delete/${filename}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    updateFileList();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ファイルの削除に失敗しました。', 'error');
                console.error('Error deleting file:', error);
            }
        }

        async function refreshDevices() {
            const refreshText = document.getElementById('refresh-text');
            const refreshSpinner = document.getElementById('refresh-spinner');
            
            refreshText.style.display = 'none';
            refreshSpinner.style.display = 'block';
            
            // キャッシュクリアを要求
            await fetch('/clear_bluetooth_cache', { method: 'POST' });
            
            await loadDevices();
            
            refreshText.style.display = 'inline';
            refreshSpinner.style.display = 'none';
        }

        function saveSelectedDevice() {
            showMessage('デバイスは自動的に保存されます', 'info');
        }

    </script>
</body>
</html>