<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>録音コントローラー | Raspberry Pi</title>
    <style>
        :root {
            --color-canvas-default: #F6F8FA;
            --color-canvas-inset: #F6F8FA;
            --color-header-bg: #24292F;
            --color-header-text: #ffffff;
            --color-text-primary: #1F2328;
            --color-text-secondary: #656D76;
            --color-border-default: #D0D7DE;
            --color-border-muted: #D8DEE4;
            --color-neutral-muted: rgba(175, 184, 193, 0.2);
            --color-accent-fg: #0969DA;
            --color-accent-emphasis: #0969DA;
            --color-success-fg: #1A7F37;
            --color-danger-fg: #CF222E;
            --color-btn-bg: #F6F8FA;
            --color-btn-hover-bg: #F3F4F6;
            --color-btn-primary-bg: #2DA44E;
            --color-btn-primary-hover-bg: #2C974B;
            --color-btn-primary-text: #ffffff;
            --color-btn-danger-hover-bg: #CF222E;
            --color-btn-danger-hover-text: #ffffff;
            --color-btn-danger-hover-border: #CF222E;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }

        body {
            margin: 0;
            background-color: var(--color-canvas-default);
            font-family: var(--font-family-sans-serif);
            color: var(--color-text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        .gh-header {
            background-color: var(--color-header-bg);
            color: var(--color-header-text);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 600;
        }

        .gh-header-icon {
            fill: currentColor;
        }

        .page-content {
            max-width: 1012px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .repo-header {
            margin-bottom: 24px;
        }

        .repo-name {
            font-size: 20px;
            font-weight: 400;
            color: var(--color-accent-fg);
        }

        .repo-name a {
            color: inherit;
            text-decoration: none;
        }

        .repo-name strong {
            font-weight: 600;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        @media (min-width: 1012px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .Box {
            background-color: #ffffff;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
        }

        .Box-header {
            padding: 12px 16px;
            background-color: var(--color-canvas-inset);
            border-bottom: 1px solid var(--color-border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .Box-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .Box-body {
            padding: 16px;
        }

        .Box-row {
            padding: 8px 16px;
            border-bottom: 1px solid var(--color-border-muted);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .Box-row:last-child {
            border-bottom: none;
        }
        .Box-row:hover {
            background-color: var(--color-canvas-default);
        }
        .Box-row.selected {
            background-color: #DDF4FF;
            border-left: 3px solid var(--color-accent-emphasis);
            padding-left: 13px;
        }
        
        .Box-row-icon {
            color: var(--color-text-secondary);
        }

        .Box-row-content {
            flex: 1;
        }
        
        .Box-row-content .text-bold {
            font-weight: 600;
        }
        
        .Box-row-content .text-muted {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        
        .Box-row-actions {
            display: flex;
            gap: 8px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 9999px;
            border: 1px solid transparent;
        }
        
        .status-badge.connected {
            color: var(--color-success-fg);
            border-color: rgba(46, 160, 67, 0.4);
            background-color: #dafbe1;
        }

        .status-badge.paired {
            color: var(--color-text-secondary);
            border-color: var(--color-border-muted);
            background-color: #F6F8FA;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            padding: 5px 16px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-btn-bg);
            cursor: pointer;
            transition: background-color 0.2s cubic-bezier(0.3, 0, 0.5, 1);
        }
        .btn:hover:not(:disabled) {
            background-color: var(--color-btn-hover-bg);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--color-btn-primary-bg);
            color: var(--color-btn-primary-text);
            border-color: rgba(27, 31, 36, 0.15);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-btn-primary-hover-bg);
        }
        
        .btn-danger {
            color: var(--color-danger-fg);
        }
        .btn-danger:hover:not(:disabled) {
            color: var(--color-btn-danger-hover-text);
            background-color: var(--color-btn-danger-hover-bg);
            border-color: var(--color-btn-danger-hover-border);
        }

        .status-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
        }
        .status-label {
            color: var(--color-text-secondary);
        }
        .status-value {
            font-weight: 600;
        }
        .status-value.success { color: var(--color-success-fg); }
        .status-value.danger { color: var(--color-danger-fg); }
        
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .empty-state {
            padding: 32px;
            text-align: center;
            color: var(--color-text-secondary);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border-default);
            border-top-color: var(--color-accent-emphasis);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .recording-indicator {
            background-color: #FFFBDD;
            border: 1px solid #EAC54F;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .recording-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #BF8700;
        }
        .recording-body {
            margin-top: 8px;
            font-size: 24px;
            font-weight: 600;
            font-family: monospace;
            text-align: center;
        }
        .recording-body small {
            display: block;
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .status-indicator-idle {
            background-color: #F0F4F8;
            color: #333;
        }
        .status-indicator-recording {
            background-color: #E1F5FE;
            color: #0277BD;
        }
        .status-indicator-error {
            background-color: #FFEBEE;
            color: #C62828;
        }
        .status-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .timer-display {
            font-family: monospace;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .user-message {
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            display: none;
        }
        .user-message.message-info {
            background-color: #E1F5FE;
            color: #0277BD;
        }
        .user-message.message-success {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        .user-message.message-error {
            background-color: #FFEBEE;
            color: #C62828;
        }
    </style>
</head>
<body>

    <header class="gh-header">
        <svg height="24" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="24" class="gh-header-icon">
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM3.5 8a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Zm2 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1Z"></path>
        </svg>
        <span>ZeroPi-TeamsRecorder</span>
    </header>

    <div class="page-content">
        <div class="repo-header">
            <div class="repo-name">
                <svg class="gh-header-icon" height="24" viewBox="0 0 16 16" version="1.1" width="24">
                    <path fill-rule="evenodd" d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25a.25.25 0 01.25-.25h3.5a.25.25 0 01.25.25v3.25a.25.25 0 01-.4.2l-1.45-1.087a.25.25 0 00-.3 0L5.4 15.7a.25.25 0 01-.4-.2v-3.25z"></path>
                </svg>
                <a href="#">Raspberry Pi</a> / <strong>Web Recorder</strong>
            </div>
            <div id="ip-address" class="text-muted" style="margin-top: 4px;">IP: -.--.--.--</div>
        </div>

        <div class="main-grid">
            <div class="main-content">
                <div class="recording-indicator" id="recording-indicator" style="display: none;">
                    <div class="recording-header">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" class="octicon octicon-broadcast">
                            <path d="M8 12.25a4.25 4.25 0 1 0 0-8.5 4.25 4.25 0 0 0 0 8.5ZM8 14a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"></path><path d="M5.25 8a.75.75 0 0 0 0 1.5h5.5a.75.75 0 0 0 0-1.5h-5.5Z"></path>
                        </svg>
                        <span>録音中です...</span>
                    </div>
                    <div class="recording-body">
                        <span id="timer">00:00:00</span>
                        <small id="filename"></small>
                    </div>
                </div>

                <div class="Box">
                    <div class="Box-header">
                        <h3 class="Box-title">録音ファイル</h3>
                    </div>
                    <div id="file-list" class="Box-body" style="padding: 0;">
                        <!-- ファイルリストがここに動的に挿入されます -->
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="Box">
                    <div class="Box-header">
                        <h3 class="Box-title">コントロール</h3>
                    </div>
                    <div class="Box-body">
                        <div id="status-indicator" class="status-indicator-idle">
                            <span class="status-icon"></span>
                            <span id="status-text">待機中</span>
                        </div>
                        <div id="timer" class="timer-display">00:00:00</div>
                        
                        <div class="control-buttons">
                            <button id="start-button" class="btn btn-primary" onclick="startRecording()" disabled>
                                <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.379 5.227A.75.75 0 0 1 7.5 5.75v4.5a.75.75 0 0 1-1.121.623l-3.5-2.25a.75.75 0 0 1 0-1.246l3.5-2.25z"></path></svg>
                                録音開始
                            </button>
                            <button id="stop-button" class="btn btn-danger" onclick="stopRecording()" disabled>
                                <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M6.25 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm3.5 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0z"></path></svg>
                                録音停止
                            </button>
                        </div>
                        <div id="user-message" class="user-message"></div>
                    </div>
                </div>

                <div class="Box" style="margin-top: 24px;">
                    <div class="Box-header">
                        <h3 class="Box-title">Bluetoothデバイス</h3>
                        <button class="btn" onclick="refreshDevices()" id="refresh-btn">
                            <span id="refresh-text">更新</span>
                            <div id="refresh-spinner" class="spinner" style="display: none;"></div>
                        </button>
                    </div>
                    <div id="device-list">
                        <div class="empty-state">
                            <p>デバイスを読み込み中...</p>
                        </div>
                    </div>
                    <div class="Box-footer" style="padding: 8px 16px; border-top: 1px solid var(--color-border-default);">
                        <button class="btn" style="width: 100%;" onclick="saveSelectedDevice()" id="save-btn" disabled>
                            このデバイスを使用する
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedDevice = null;
        let statusInterval;
        let timerInterval;
        let recordingStartTime;

        // === 初期化処理 ===
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            updateFileList();
            statusInterval = setInterval(updateStatus, 1000); // 1秒ごとにステータスを更新
        });

        // === UI更新関数 ===
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('user-message');
            messageEl.textContent = text;
            messageEl.className = `user-message message-${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
        }

        function updateButtonStates() {
            const startBtn = document.getElementById('start-button');
            const stopBtn = document.getElementById('stop-button');
            const isRecording = document.getElementById('status-indicator').classList.contains('status-indicator-recording');

            startBtn.disabled = isRecording || !selectedDevice;
            stopBtn.disabled = !isRecording;
        }

        function updateTimer() {
            if (!recordingStartTime) return;
            const now = Date.now();
            const elapsed = Math.floor((now - recordingStartTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // === データ取得・操作関数 ===
        async function loadDevices() {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = ''; // リストをクリア

            try {
                const response = await fetch('/get_devices');
                const data = await response.json();
                
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        const row = document.createElement('div');
                        row.className = 'Box-row';
                        row.onclick = () => selectDevice(row, device);

                        let statusBadge = '';
                        if (device.connected) {
                            statusBadge = `<span class="status-badge connected"><span class="status-dot"></span>接続済み</span>`;
                        } else if (device.paired) {
                            statusBadge = `<span class="status-badge paired">ペアリング済み</span>`;
                        }

                        row.innerHTML = `
                            <div class="Box-row-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M3.75 0a.75.75 0 0 0-1.5 0v4.333L.97 3.05a.75.75 0 0 0-1.06 1.06L2.5 6.75v2.5L-.11 11.89a.75.75 0 1 0 1.06 1.06l1.28-1.28V16a.75.75 0 0 0 1.5 0v-4.333l1.28 1.28a.75.75 0 0 0 1.06-1.06L3.75 9.25v-2.5l2.61-2.64a.75.75 0 0 0-1.06-1.06L3.75 4.333V0Zm1.5 6L7.86 3.39a.75.75 0 0 1 1.06 1.06L6.31 7.06a.75.75 0 0 1 0 1.06l2.61 2.61a.75.75 0 1 1-1.06 1.06L5.25 9.18v-3.18Zm3.69 2.61L11.55 6l-2.61-2.61a.75.75 0 0 1 1.06-1.06l3.16 3.16a.75.75 0 0 1 0 1.06l-3.16 3.16a.75.75 0 1 1-1.06-1.06Z"></path>
                            </div>
                            <div class="Box-row-content">
                                <span class="text-bold">${device.name}</span>
                                <div class="text-muted">${device.mac}</div>
                            </div>
                            ${statusBadge}
                        `;
                        deviceList.appendChild(row);
                    });
                } else {
                    deviceList.innerHTML = '<div class="Box-row">利用可能なデバイスが見つかりません。</div>';
                }
            } catch (error) {
                console.error('デバイス一覧の取得に失敗:', error);
                deviceList.innerHTML = '<div class="Box-row text-danger">デバイス一覧の取得に失敗しました。</div>';
            }
        }

        async function selectDevice(element, device) {
            // 既存の選択を解除
            document.querySelectorAll('#device-list .Box-row').forEach(el => el.classList.remove('selected'));
            // 新しいデバイスを選択
            element.classList.add('selected');
            selectedDevice = device;
            showMessage(`デバイス「${device.name}」を選択しました。`);

            try {
                const response = await fetch('/save_device', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(device)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    // 接続状態をチェックしてUIを更新
                    await checkConnection(device.mac);
                } else {
                    showMessage(result.message, 'error');
                    selectedDevice = null;
                    element.classList.remove('selected');
                }
            } catch (error) {
                showMessage('デバイスの保存に失敗しました。', 'error');
                console.error('Error saving device:', error);
            }
            updateButtonStates();
        }

        async function checkConnection(mac_address) {
            try {
                // GETではなく、サーバーの仕様に合わせてPOSTでリクエストを送信する
                const response = await fetch('/check_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mac: mac_address }) // データをJSON形式で送信
                });
                const data = await response.json();
                if (data.connected) {
                    showMessage(`デバイス ${mac_address} に接続済みです。`, 'success');
                } else {
                    showMessage(`デバイス ${mac_address} への接続を試みています...`, 'info');
                }
                // デバイスリストを再読み込みして状態バッジを更新
                loadDevices();
            } catch (error) {
                console.error('接続確認エラー:', error);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/get_status');
                const data = await response.json();

                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                const ipAddressEl = document.getElementById('ip-address');

                ipAddressEl.textContent = `IP: ${data.ip_address || '-.--.--.--'}`;

                if (data.recording) {
                    statusIndicator.className = 'status-indicator-recording';
                    statusText.textContent = `録音中: ${data.filename || ''}`;
                    if (!timerInterval) {
                        // サーバーの開始時間からタイマーを初期化
                        recordingStartTime = Date.now() - ((data.start_time ? (Date.now() / 1000 - data.start_time) : 0) * 1000);
                        timerInterval = setInterval(updateTimer, 1000);
                    }
                } else {
                    statusIndicator.className = 'status-indicator-idle';
                    statusText.textContent = '待機中';
                    if (data.status === 'error') {
                        statusIndicator.className = 'status-indicator-error';
                        statusText.textContent = `エラー: ${data.error_message}`;
                    }
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.getElementById('timer').textContent = '00:00:00';
                }
                updateButtonStates();
            } catch (error) {
                console.error('ステータスの更新に失敗:', error);
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                statusIndicator.className = 'status-indicator-error';
                statusText.textContent = 'サーバー接続断';
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        async function startRecording() {
            if (!selectedDevice) {
                showMessage('録音を開始する前にデバイスを選択してください。', 'error');
                return;
            }
            showMessage('録音開始リクエストを送信しました...');
            try {
                const response = await fetch('/start_recording', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        device: selectedDevice,
                        duration: 120
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    updateStatus(); // すぐにステータスを更新
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('録音の開始に失敗しました。', 'error');
                console.error('Error starting recording:', error);
            }
        }

        async function stopRecording() {
            showMessage('録音停止リクエストを送信しました...');
            try {
                const response = await fetch('/stop_recording', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('録音の停止に失敗しました。', 'error');
                console.error('Error stopping recording:', error);
            }
            // UIを即座にリセット
            clearInterval(timerInterval);
            timerInterval = null;
            document.getElementById('timer').textContent = '00:00:00';
            document.getElementById('status-indicator').className = 'status-indicator-idle';
            document.getElementById('status-text').textContent = '待機中';
            updateButtonStates();
            setTimeout(updateFileList, 1000); // ファイルリストの更新を少し遅らせる
        }

        async function updateFileList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<div class="Box-row"><div class="spinner"></div>&nbsp;読み込み中...</div>'; // 読み込み中の表示

            try {
                const response = await fetch('/get_files');
                const data = await response.json();

                // data.files が配列であることを確認してから処理する
                if (data && Array.isArray(data.files) && data.files.length > 0) {
                    fileList.innerHTML = data.files.map(file => `
                        <div class="Box-row">
                            <div class="Box-row-icon">
                                <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16">
                                    <path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586a.75.75 0 0 1 .53.22l2.914 2.914a.75.75 0 0 1 .22.53V14.25c0 .966-.784 1.75-1.75 1.75H3.75A1.75 1.75 0 0 1 2 14.25V1.75Z"></path>
                                </svg>
                            </div>
                            <div class="Box-row-content">
                                <a href="/download/${file}" style="text-decoration: none; color: inherit;">${file}</a>
                            </div>
                            <div class="Box-row-actions">
                                <button class="btn" onclick="downloadFile('${file}')">Download</button>
                                <button class="btn btn-danger" onclick="deleteFile('${file}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    fileList.innerHTML = '<div class="empty-state"><p>録音ファイルはありません。</p></div>';
                }
            } catch (error) {
                console.error('ファイルリストの取得に失敗:', error);
                fileList.innerHTML = '<div class="empty-state"><p style="color: var(--color-danger-fg);">ファイルリストの取得に失敗しました。</p></div>';
            }
        }

        function downloadFile(filename) {
            window.location.href = `/download/${filename}`;
        }

        async function deleteFile(filename) {
            if (!confirm(`本当にファイル「${filename}」を削除しますか？`)) {
                return;
            }
            try {
                const response = await fetch(`/delete/${filename}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message, 'success');
                    updateFileList(); // リストを更新
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ファイルの削除に失敗しました。', 'error');
                console.error('Error deleting file:', error);
            }
        }

        // === 追加で必要な関数 ===
        async function refreshDevices() {
            const refreshText = document.getElementById('refresh-text');
            const refreshSpinner = document.getElementById('refresh-spinner');
            
            refreshText.style.display = 'none';
            refreshSpinner.style.display = 'block';
            
            await loadDevices();
            
            refreshText.style.display = 'inline';
            refreshSpinner.style.display = 'none';
        }

        function saveSelectedDevice() {
            // この関数は現在のフローでは不要（selectDevice内で自動保存）
            showMessage('デバイスは自動的に保存されます', 'info');
        }

    </script>
</body>
</html>